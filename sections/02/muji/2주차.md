# 이미지는 읽기 전용!

## 이미지와 컨테이너가 작동하는 방식

- 예) 노드 애플리케이션 코드를 변경하고 싶을 때
- 코드 변경을 통해 “My Course Goal!”이라는 멘트를 html에 띄움
    
    ```jsx
    ...
    
    app.get("/", (req, res) => {
      res.send(`
        <html>
          <head>
            <link rel="stylesheet" href="style.css">
          </head>
          <body>
            <section>
              <h2>My Course Goal!</h2>
              <h3>${userGoal}</h3>
            </section>
            <form action="/store-goal" method="POST">
              <div class="form-control">
                <label>Course Goal</label>
                <input type="text" name="goal">
              </div>
              <button>Set Course Goal</button>
            </form>
          </body>
        </html>
      `);
    });
    
    ...
    ```
    
    - 컨테이너 다시 시작
    - docker ps 사용한 다시 시작
        - 실행 중인 컨테이너 확인 → 컨테이너 이름 선택 → docker stop을 실행하여 중지 → 다시 시작
    - 그러나 변경 사항이 반영되지 않음
- 도커 파일은 소스 코드를 컨테이너 파일 시스템에 보관하는 server.js 파일을 포함하여 프로젝트 폴더 내의 모든 것을 app 폴더에 정확하게 복사하도록 지시함(이미지 파일 시스템)
- 이후 `npm install` 실행 → 도커에게 port 80 실행 → 컨테이너 시작 시 서버 시작 알림
    - 컨테이너 시작 시 소스 코드를 이미지에 복사하고 기본적으로 복사한 시점에서 소스 코드의 스냅샷 생성

→ 따라서 위 변경 사항은 이미지 소스 코드에 포함 X

### 업데이트된 소스 코드 새 이미지로 복사하기

- 코드 변경 시마다 이미지 다시 빌드가 필요함
- `docker build .`을 다시 실행하여 이미지 다시 빌드(새 이미지 빌드가 필요함)
- `docker run -p 3000:80 [이미지 이름]` 으로 도커에서 실행
- 위 작업 수행 후 `localhost:3000`  로드 시 변경 사항이 적용된 것을 알 수 있음
- 따라서 이미지는 **닫힌 템플릿**

# 이미지 레이어 이해하기

- 위 내용처럼 이미지 빌드 시 아래 명령이 실행되고 이미지가 닫힘
    
    ```docker
    FROM node
    
    WORKDIR /app
    
    COPY . /app
    
    RUN npm install
    
    EXPOSE 80
    
    CMD ["node", "server.js"]
    ```
    
    - `COPY`를 사용하여 복사했기 때문에 무언가를 업데이트할 경우 다시 빌드해야 함
- 코드 변경 후 이미지 다시 작성
- 위에서 살펴본 바와 같이 **이미지는 레이어 기반**
- 즉, 이미지를 빌드할 때 변경된 부분의 명령과 그 이후의 모든 명령이 재평가됨

### 코드 변경 없이 이미지 빌드

- 캐쉬 사용(Using cache)
    - 도커는 기본적으로 같은 명령어를 재실행했을 때의 결과가 이전과 동일하다는 것을 인식함
    -
